<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sweet O'Clock ‚Äî Realtime Ladoo Shop</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg1: #fff7f0;
  --accent: #ff7043;
  --muted: #6b7280;
  --card: #fff;
  --purple: #8e44ad;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),#fff1f2);color:#111}
header{background:linear-gradient(90deg,var(--accent),#ffbf5e);color:#fff;padding:18px;text-align:center;font-weight:700;position:sticky;top:0;z-index:10}
.wrap{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
h3{margin:6px 0 10px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eee;font-size:14px}
button{background:var(--purple);color:#fff;border:0;padding:9px;border-radius:8px;cursor:pointer;transition:all 0.2s}
button:hover{opacity:0.85;transform:scale(1.03);}
button.ghost{background:transparent;color:var(--muted);border:1px solid #eee}
.row{display:flex;gap:8px}
.row > *{flex:1}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border:1px solid #f3f3f3;text-align:center;font-size:13px}
th{background:linear-gradient(90deg,var(--accent),#ffbf5e);color:white}
.status-btn{padding:6px 10px;border-radius:8px;border:0;color:#fff;cursor:pointer}
.delivered{background:#16a34a}.notdel{background:#ef4444}
.paid{background:#0ea5e9}.notpaid{background:#7c3aed}
.small{font-size:13px;color:var(--muted)}
.pager{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-top:8px}
canvas#ladooCanvas{position:fixed;left:0;top:0;pointer-events:none;z-index:9999}
@media (max-width:980px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>üç¨ Sweet O'Clock ‚Äî Realtime Shop</header>
<div class="wrap">

<!-- LEFT COLUMN -->
<div style="display:flex;flex-direction:column;gap:12px">
  <!-- Products -->
  <div class="card">
    <h3>Products & Prices</h3>
    <label>New product name</label>
    <input id="newProductName" placeholder="Dry Fruit Laddoo">
    <div class="row" style="margin-top:8px">
      <button id="btnAddProduct">Add Product</button>
      <button id="btnRefreshProducts" class="ghost">Refresh</button>
    </div>
    <hr style="margin:10px 0;border-top:1px solid #f3f3f3">
    <label>Prices (edit & Save)</label>
    <div id="pricesList" class="small"></div>
  </div>

  <!-- Inventory -->
  <div class="card">
    <h3>Inventory (per product)</h3>
    <label>Select product</label>
    <select id="invProductSelect"></select>
    <div class="row" style="margin-top:8px">
      <input id="inv250" placeholder="250g boxes">
      <input id="inv500" placeholder="500g boxes">
      <input id="inv1000" placeholder="1kg boxes">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSaveInv">Save Inventory</button>
    </div>
    <label style="margin-top:10px">Add production (Kg) ‚Äî distribute</label>
    <div class="row">
      <input id="prodKg" placeholder="e.g. 20">
      <button id="btnAddProd" class="ghost">Distribute</button>
    </div>
    <div id="invList" class="small" style="margin-top:10px"></div>
  </div>

  <!-- Customers -->
  <div class="card">
    <h3>Customers</h3>
    <label>Name</label><input id="custName" placeholder="Customer name">
    <label>Contact</label><input id="custContact" placeholder="Phone">
    <label>Address</label><input id="custAddress" placeholder="City / area">
    <div class="row" style="margin-top:8px">
      <button id="btnSaveCustomer">Save</button>
      <button id="btnClearCust" class="ghost">Clear</button>
    </div>
    <div class="small" style="margin-top:8px">Saved customers appear in the order form.</div>
  </div>
</div>

<!-- RIGHT COLUMN -->
<div style="display:flex;flex-direction:column;gap:12px">
  <!-- Orders -->
  <div class="card">
    <h3>Place Order</h3>
    <div class="row">
      <select id="customerSelect"></select>
      <select id="productSelect"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="sizeSelect">
        <option value="250">250 g</option>
        <option value="500">500 g</option>
        <option value="1000">1 kg</option>
      </select>
      <input id="qty" type="number" min="1" value="1">
    </div>
    <div class="row" style="margin-top:8px">
      <select id="deliverySelect"><option value="0">Local</option><option value="100">Outstation (+‚Çπ100)</option></select>
      <select id="payMode"><option>Online Company A/c</option><option>Cash</option></select>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnPlaceOrder">Generate Bill & Place Order</button>
      <button id="btnPreview" class="ghost">Preview Bill</button>
    </div>
    <div id="billPreview" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <h3>Orders (5 / page)</h3>
    <table id="ordersTable">
      <thead><tr><th>Cust</th><th>Prod</th><th>Size</th><th>Qty</th><th>Total</th><th>Delivery</th><th>PayMode</th><th>Delivered</th><th>Paid</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="pager">
      <button id="prevPage" class="ghost">Prev</button>
      <div id="pageInfo" class="small">Page 1</div>
      <button id="nextPage" class="ghost">Next</button>
    </div>
  </div>

  <!-- Stock Analysis -->
  <div class="card">
    <h3>Analysis</h3>
    <canvas id="byProductChart" height="120"></canvas>
    <canvas id="bySizeChart" height="120" style="margin-top:12px"></canvas>
  </div>

  <!-- Available stock -->
  <div class="card">
    <h3>Available Stock</h3>
    <div id="stockList" class="small"></div>
  </div>
</div>
</div>

<!-- Ladoo rain canvas -->
<canvas id="ladooCanvas"></canvas>

<!-- Firebase + Logic -->
<script type="module">
// ===== Replace Firebase config with yours =====
const firebaseConfig = {
  apiKey: "AIzaSyCLlkJdb0iUyFnuOQUV_2mo3u88kx8OfyE",
  authDomain: "sweet-o-clocl.firebaseapp.com",
  databaseURL: "https://sweet-o-clocl-default-rtdb.firebaseio.com",
  projectId: "sweet-o-clocl",
  storageBucket: "sweet-o-clocl.firebasestorage.app",
  messagingSenderId: "756826109350",
  appId: "1:756826109350:web:00dc171cbe8a475a078b67",
  measurementId: "G-ZT4HY701LT"
};
// ===========================================

// Firebase modular imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM
const newProductName = document.getElementById('newProductName');
const btnAddProduct = document.getElementById('btnAddProduct');
const btnRefreshProducts = document.getElementById('btnRefreshProducts');
const pricesList = document.getElementById('pricesList');

const invProductSelect = document.getElementById('invProductSelect');
const inv250 = document.getElementById('inv250'), inv500 = document.getElementById('inv500'), inv1000 = document.getElementById('inv1000');
const btnSaveInv = document.getElementById('btnSaveInv'), btnAddProd = document.getElementById('btnAddProd');
const prodKg = document.getElementById('prodKg');
const invList = document.getElementById('invList');

const custName = document.getElementById('custName'), custContact = document.getElementById('custContact'), custAddress = document.getElementById('custAddress');
const btnSaveCustomer = document.getElementById('btnSaveCustomer'), btnClearCust = document.getElementById('btnClearCust');
const customerSelect = document.getElementById('customerSelect');

const productSelect = document.getElementById('productSelect'), sizeSelect = document.getElementById('sizeSelect'), qtyInput = document.getElementById('qty');
const deliverySelect = document.getElementById('deliverySelect'), payMode = document.getElementById('payMode'), btnPlaceOrder = document.getElementById('btnPlaceOrder'), btnPreview = document.getElementById('btnPreview');
const billPreview = document.getElementById('billPreview');
const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
const prevPage = document.getElementById('prevPage'), nextPage = document.getElementById('nextPage'), pageInfo = document.getElementById('pageInfo');

const stockList = document.getElementById('stockList');

// State
let products = {}, customers = {}, inventory = {}, orders = [];
let currentPage = 1, perPage = 5;

// ======= PRODUCTS =======
function loadProducts(){
  pricesList.innerHTML=''; invProductSelect.innerHTML=''; productSelect.innerHTML='';
  const prodRef = ref(db,'products');
  onValue(prodRef, snapshot=>{
    products = snapshot.val()||{};
    for(let pid in products){
      const p = products[pid];
      // Prices UI
      const div = document.createElement('div');
      div.innerHTML = `<b>${p.name}</b> ‚Äî ‚Çπ <input type="number" min="0" value="${p.price250||0}" data-box="250" data-id="${pid}"> / 250g,
                        ‚Çπ <input type="number" min="0" value="${p.price500||0}" data-box="500" data-id="${pid}"> / 500g,
                        ‚Çπ <input type="number" min="0" value="${p.price1000||0}" data-box="1000" data-id="${pid}"> / 1kg
                        <button data-id="${pid}">Save</button>`;
      pricesList.appendChild(div);
      div.querySelector('button').onclick = ()=>savePrices(pid,div);
      // Inventory select
      invProductSelect.innerHTML += `<option value="${pid}">${p.name}</option>`;
      // Product select for order
      productSelect.innerHTML += `<option value="${pid}">${p.name}</option>`;
    }
  });
}

function savePrices(pid,div){
  const inputs = div.querySelectorAll('input');
  const updates = {};
  inputs.forEach(inp=>{
    const box = inp.dataset.box;
    if(box==='250') updates.price250 = Number(inp.value);
    if(box==='500') updates.price500 = Number(inp.value);
    if(box==='1000') updates.price1000 = Number(inp.value);
  });
  update(ref(db,'products/'+pid),updates);
}

btnAddProduct.onclick = ()=>{
  const name = newProductName.value.trim();
  if(!name){alert('Enter product name');return;}
  const prodRef = ref(db,'products');
  const newProd = push(prodRef);
  set(newProd,{name:name,price250:0,price500:0,price1000:0});
  newProductName.value='';
}

btnRefreshProducts.onclick = ()=>loadProducts();

// ======= CUSTOMERS =======
function loadCustomers(){
  customerSelect.innerHTML='';
  const custRef = ref(db,'customers');
  onValue(custRef,snapshot=>{
    customers = snapshot.val()||{};
    for(let cid in customers){
      const c = customers[cid];
      customerSelect.innerHTML += `<option value="${cid}">${c.name}</option>`;
    }
  });
}

btnSaveCustomer.onclick = ()=>{
  const name=custName.value.trim(),contact=custContact.value.trim(),addr=custAddress.value.trim();
  if(!name||!contact||!addr){alert('Fill all fields');return;}
  const custRef = ref(db,'customers');
  const newCust = push(custRef);
  set(newCust,{name,phone:contact,address:addr});
  custName.value=''; custContact.value=''; custAddress.value='';
}

// ======= INVENTORY =======
function loadInventory(){
  invList.innerHTML='';
  const invRef = ref(db,'inventory');
  onValue(invRef,snapshot=>{
    inventory = snapshot.val()||{};
    for(let pid in products){
      const inv = inventory[pid]||{boxes250:0,boxes500:0,boxes1000:0};
      invList.innerHTML += `<b>${products[pid].name}</b> ‚Äî 250g: ${inv.boxes250}, 500g: ${inv.boxes500}, 1kg: ${inv.boxes1000}<br>`;
    }
  });
}

btnSaveInv.onclick = ()=>{
  const pid = invProductSelect.value;
  const updates = {
    boxes250:Number(inv250.value)||0,
    boxes500:Number(inv500.value)||0,
    boxes1000:Number(inv1000.value)||0
  };
  update(ref(db,'inventory/'+pid),updates);
}

btnAddProd.onclick = ()=>{
  const pid = invProductSelect.value;
  const totalKg = Number(prodKg.value)||0;
  if(totalKg<=0){alert('Enter production');return;}
  const invRef = ref(db,'inventory/'+pid);
  runTransaction(invRef,current=>{
    if(current){
      current.boxes250 += Math.floor(totalKg*4); // simple distribution
      current.boxes500 += Math.floor(totalKg*2);
      current.boxes1000 += Math.floor(totalKg*1);
      return current;
    } else return {boxes250: Math.floor(totalKg*4), boxes500:Math.floor(totalKg*2), boxes1000:Math.floor(totalKg*1)};
  });
  prodKg.value='';
}

// ======= ORDERS =======
btnPlaceOrder.onclick = async()=>{
  const cid = customerSelect.value, pid = productSelect.value;
  const size = sizeSelect.value, qty = Number(qtyInput.value)||0;
  if(!cid||!pid||qty<=0){alert('Select product/customer & qty');return;}
  const inv = inventory[pid]||{boxes250:0,boxes500:0,boxes1000:0};
  const boxField = size==='250'?'boxes250':size==='500'?'boxes500':'boxes1000';
  if(inv[boxField]<qty){alert('Insufficient stock');return;}
  const p = products[pid];
  const cust = customers[cid];
  const price = size==='250'?p.price250:size==='500'?p.price500:p.price1000;
  const total = price*qty+Number(deliverySelect.value||0);
  const orderRef = push(ref(db,'orders'));
  set(orderRef,{customer: cust.name,product:p.name,size,qty,total,delivery:deliverySelect.value,payMode:payMode.value,delivered:false,paid:false});
  // reduce inventory
  update(ref(db,'inventory/'+pid),{[boxField]:inv[boxField]-qty});
  alert('Order placed!');
}

// ======= ORDERS TABLE + PAGINATION =======
function loadOrders(){
  const ordersRef = ref(db,'orders');
  onValue(ordersRef,snapshot=>{
    orders = [];
    snapshot.forEach(snap=>{
      const o = snap.val(); o.id=snap.key; orders.push(o);
    });
    currentPage=1; renderOrdersPage();
  });
}

function renderOrdersPage(){
  ordersTable.innerHTML='';
  const start=(currentPage-1)*perPage;
  const pageOrders = orders.slice(start,start+perPage);
  pageOrders.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${o.customer}</td><td>${o.product}</td><td>${o.size}</td><td>${o.qty}</td><td>${o.total}</td><td>${o.delivery}</td><td>${o.payMode}</td>
    <td><button class="status-btn ${o.delivered?'delivered':'notdel'}" onclick="toggleDelivered('${o.id}',${!o.delivered})">${o.delivered?'Yes':'No'}</button></td>
    <td><button class="status-btn ${o.paid?'paid':'notpaid'}" onclick="togglePaid('${o.id}',${!o.paid})">${o.paid?'Yes':'No'}</button></td>`;
    ordersTable.appendChild(tr);
  });
  pageInfo.innerText=`Page ${currentPage}`;
}

prevPage.onclick=()=>{if(currentPage>1){currentPage--;renderOrdersPage();}};
nextPage.onclick=()=>{if(currentPage*perPage<orders.length){currentPage++;renderOrdersPage();}};

window.toggleDelivered=(id,val)=>update(ref(db,'orders/'+id),{delivered:val});
window.togglePaid=(id,val)=>update(ref(db,'orders/'+id),{paid:val});

// ======= STOCK LIST =======
function renderStock(){
  stockList.innerHTML='';
  for(let pid in products){
    const inv = inventory[pid]||{boxes250:0,boxes500:0,boxes1000:0};
    stockList.innerHTML += `<b>${products[pid].name}</b> ‚Äî 250g: ${inv.boxes250}, 500g: ${inv.boxes500}, 1kg: ${inv.boxes1000}<br>`;
  }
}

// ======= ANALYSIS =======
let byProductChart,bySizeChart;
function renderAnalysis(){
  const prodSales={}, sizeSales={'250':0,'500':0,'1000':0};
  orders.forEach(o=>{
    prodSales[o.product] = (prodSales[o.product]||0)+o.qty;
    sizeSales[o.size] += o.qty;
  });
  // Product chart
  const ctx1 = document.getElementById('byProductChart');
  if(byProductChart) byProductChart.destroy();
  byProductChart = new Chart(ctx1,{type:'bar',data:{labels:Object.keys(prodSales),datasets:[{label:'Qty sold',data:Object.values(prodSales),backgroundColor:'#ff7043'}]},options:{responsive:true}});
  // Size chart
  const ctx2 = document.getElementById('bySizeChart');
  if(bySizeChart) bySizeChart.destroy();
  bySizeChart = new Chart(ctx2,{type:'pie',data:{labels:Object.keys(sizeSales),datasets:[{label:'Qty',data:Object.values(sizeSales),backgroundColor:['#ff7043','#ffa64d','#ffb366']}]},options:{responsive:true}});
}

// ======= Ladoo Rain =======
const canvas = document.getElementById('ladooCanvas'), ctx=canvas.getContext('2d');
canvas.width=window.innerWidth; canvas.height=window.innerHeight;
let laddoos=[];
for(let i=0;i<30;i++){laddoos.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,dy:1+Math.random()*2})}
function drawLadoo(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  laddoos.forEach(l=>{
    ctx.font='24px Arial'; ctx.fillText('üü†',l.x,l.y);
    l.y+=l.dy;
    if(l.y>canvas.height) l.y=0;
  });
  requestAnimationFrame(drawLadoo);
}
drawLadoo();

// ======= INITIAL LOAD =======
loadProducts(); loadCustomers(); loadInventory(); loadOrders();
onValue(ref(db,'inventory'),snapshot=>{inventory=snapshot.val()||{}; renderStock(); renderAnalysis();});
onValue(ref(db,'orders'),snapshot=>{orders=[];snapshot.forEach(snap=>{const o=snap.val(); o.id=snap.key; orders.push(o);}); renderOrdersPage(); renderAnalysis();});

</script>
</body>
</html>
